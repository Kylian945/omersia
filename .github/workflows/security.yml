name: Security Audit

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  backend-security:
    name: Backend Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, iconv, json, mbstring, pdo
          coverage: none

      - name: Validate composer.json
        run: |
          cd backend
          composer validate --no-check-publish --no-check-lock --no-check-all || echo "::warning::Composer validation has warnings (expected for monorepo path packages)"

      - name: Cache Composer dependencies
        uses: actions/cache@v5
        with:
          path: backend/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: |
          cd backend
          composer install --prefer-dist --no-progress --no-interaction

      - name: Run Composer audit
        run: |
          cd backend
          composer audit --format=plain --abandoned=report

      - name: Check for known security issues
        run: |
          cd backend
          composer audit --no-dev --locked --abandoned=ignore || echo "::warning::Security vulnerabilities found in dependencies"

  frontend-security:
    name: Frontend Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: storefront/package-lock.json

      - name: Install npm dependencies
        run: |
          cd storefront
          npm ci

      - name: Run npm audit
        run: |
          cd storefront
          npm audit --audit-level=high

      - name: Check for outdated packages
        run: |
          cd storefront
          npm outdated || true

  docker-security:
    name: Docker Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner on backend Dockerfile
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'backend/Dockerfile.dev'
          format: 'sarif'
          output: 'trivy-backend.sarif'

      - name: Upload Trivy backend results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-backend.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-backend.sarif'
          category: 'docker-backend'

      - name: Run Trivy vulnerability scanner on storefront Dockerfile
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'storefront/Dockerfile.dev'
          format: 'sarif'
          output: 'trivy-storefront.sarif'

      - name: Upload Trivy storefront results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-storefront.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-storefront.sarif'
          category: 'docker-storefront'

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [backend-security, frontend-security, docker-security]
    if: always()

    steps:
      - name: Security audit summary
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Security: ${{ needs.backend-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Security: ${{ needs.frontend-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Security: ${{ needs.docker-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the job logs above for detailed vulnerability reports." >> $GITHUB_STEP_SUMMARY
