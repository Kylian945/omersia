# ========================================
# ENVIRONNEMENT DEV
# Tout dans Docker (MySQL + Backend + Storefront + Meilisearch + Mailpit)
# Usage: docker compose -f docker-compose.dev.yml up -d
# ========================================
version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: omersia_mysql_dev
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${DB_DATABASE:-omersia}
      MYSQL_USER: ${DB_USERNAME:-omersia}
      MYSQL_PASSWORD: ${DB_PASSWORD:-omersia}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - omersia_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${DB_USERNAME:-omersia}", "-p${DB_PASSWORD:-omersia}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Meilisearch
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: omersia_meilisearch_dev
    environment:
      - MEILI_ENV=development
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-Bountie9663+Lucie607.}
      - MEILI_NO_ANALYTICS=true
    volumes:
      - meilisearch_data:/meili_data
    networks:
      - omersia_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--spider", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Mailpit (Email testing)
  mailpit:
    image: axllent/mailpit:latest
    container_name: omersia_mailpit_dev
    ports:
      - "8025:8025"  # Interface web
      - "1025:1025"  # SMTP server
    networks:
      - omersia_network
    restart: unless-stopped

  # Laravel Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: omersia_backend_dev
    volumes:
      - ./backend:/var/www/html
      - backend_vendor:/var/www/html/vendor
    env_file:
      - ./backend/.env.dev
    depends_on:
      mysql:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      mailpit:
        condition: service_started
    networks:
      - omersia_network
    restart: unless-stopped
    command: sh /var/www/html/docker-entrypoint.sh

  # Next.js Storefront
  storefront:
    build:
      context: ./storefront
      dockerfile: Dockerfile.dev
    container_name: omersia_storefront_dev
    volumes:
      - ./storefront:/app
      - storefront_node_modules:/app/node_modules
      - /app/.next
    env_file:
      - ./storefront/.env.dev
    networks:
      - omersia_network
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: omersia_nginx_dev
    ports:
      - "8000:80"
    volumes:
      - ./nginx.dev.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      backend:
        condition: service_started
      storefront:
        condition: service_started
      meilisearch:
        condition: service_healthy
    networks:
      - omersia_network
    restart: unless-stopped

networks:
  omersia_network:
    driver: bridge

volumes:
  mysql_data:
  meilisearch_data:
  backend_vendor:
  storefront_node_modules:
